name: Performance CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  performance-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements-unified.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-unified.txt
        pip install -e .

    - name: Check for placeholders
      run: |
        ! grep -R --line-number --fixed-strings "..." . \
          --exclude-dir=.git \
          --exclude-dir=.github \
          --exclude-dir=__pycache__ \
          --exclude="*.md" \
          --exclude="*.txt" \
          | grep -v "Field(...)" || { echo "Placeholder code found"; exit 1; }

    - name: Run synthetic backtest
      run: |
        python -m src.strategy.backtest_runner \
          --config config/backtest_config.yaml \
          --seed 1337 \
          --output out/backtest_results.parquet || echo "Module not implemented yet"

    - name: Evaluate backtest results
      run: |
        mkdir -p out
        python scripts/evaluate_backtest.py \
          --input out/backtest_results.parquet \
          --outdir out/eval_ci

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Start infrastructure
      run: |
        cp .env.example .env
        docker compose -f infra/compose.yaml up -d --build || echo "Docker compose not ready"

    - name: Wait for services
      run: |
        sleep 10
        curl -sf http://localhost:8080/healthz || echo "Router not ready"

    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install -y k6 || npm install -g k6

    - name: Run k6 performance test
      run: |
        k6 run --vus 50 --duration 30s \
          -e BASE_URL=http://localhost:8080 \
          --summary-export out/k6_http_ci.json \
          benchmarks/bench_http_k6.js || echo "k6 test skipped - router not ready"

    - name: Collect Prometheus snapshot
      if: always()
      run: |
        PROM=$(docker ps --filter "ancestor=prom/prometheus:latest" -q | head -n1)
        if [ ! -z "$PROM" ]; then
          docker exec "$PROM" wget -qO- "http://localhost:9090/api/v1/admin/tsdb/snapshot?skip_head=true" || true
          SNAP=$(docker exec "$PROM" sh -lc "ls -1 /prometheus/snapshots 2>/dev/null | tail -n1" | tr -d '\r')
          if [ ! -z "$SNAP" ]; then
            docker cp "$PROM":/prometheus/snapshots/$SNAP out/prom_snapshot || true
          fi
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-evidence
        path: |
          out/eval_ci/
          out/k6_http_ci.json
          out/prom_snapshot/
        retention-days: 30

    - name: Performance gate check
      run: |
        if [ -f out/eval_ci/metrics_summary.json ]; then
          sharpe=$(python -c "import json; print(json.load(open('out/eval_ci/metrics_summary.json'))['sharpe_ratio'])")
          python -c "exit(0 if $sharpe > 0 else 1)" || echo "Warning: Sharpe ratio below threshold"
        fi

    - name: Cleanup
      if: always()
      run: |
        docker compose -f infra/compose.yaml down -v || true